sudo: required

dist: xenial

services:
  - docker

language: bash

# SLUG    - converts Gihub slug (`lncm/docker-lnd`) to Docker slug (`lncm/lnd`)
# VER     - if TAG is being build, VER contains only MAJOR and MINOR parts of the version (ex. `0.6.0` -> `0.6`)
# DIR     - if BRANCH is being built, use DIR with the highest version number
# PREFIX  - sets Dockerfile prefix.  Be it based on `git tag`, or highest-version DIR name
env:
  global:
    - SLUG="${TRAVIS_REPO_SLUG/docker-/}"
    - VER=$(echo ${TRAVIS_TAG} | cut -d. -f1,2)
    - DIR=$(ls -vd */ | grep '^[0-9]' | tail -n 1 | tr -d /)
    - PREFIX="${VER:-$DIR}"

stages:
  - build
  - name: deploy
    if: tag IS present

jobs:
  include:
    - stage: build
      name: "Build Docker image for amd64"
      env: ARCH=linux-amd64

    - name: "Build Docker image for arm32v6"
      env: ARCH=linux-armv6

    - name: "Build Docker image for arm32v7"
      env: ARCH=linux-armv7
    
    - name: "Build docker image for arm64v8"
      env: ARCH=linux-armv8

    - stage: deploy
      name: "Aggregate Docker images under one manifest"
      script: ./travis/docker-manifest.sh

    - name: "Upload Docker containers to Github Releases"
      deploy:
        skip_cleanup: true
        provider: releases
        api_key:
          secure: LazeJYgGApiI/V4idyMGvxkH77Go7bRdOQMqYgcACr+bNIVJsUChi1ZzwP9hNudx3j7pmivtDCaUcZzDFJ/Wl9715UeL7oi3c3vDFO15Fp9H89PcY96DtmTaReZkOhIeHTiMh4tMgiZZVGoqeh3Sl3MDXBNsxPywkV1eE0KBV+X2WdzX9x6uV6FG0Hq3H5araQt4sHFD148kTRD7bn2cOeDDAAPiCQo0FRNvNaGPRwNlth0OLwQuxwboDTA6F6jTWxInd/VEM1cZBomYWbE243oTDT3+v4hkknQ99jtus51z+xjwPyigXM15ev6KaGviJGyVtOvDMcE3g2GsCdoCNtDHVoVeLV8lfWrQKsMh+1i6d38zo3VfCz51SXzQiqk9Bn93s43Z6lApAuqJfQWU4rynFIHVFTWo7gG5wlnUR5kjQ1w9+u94EJ2iZdi3W6Lx3RHS6JCCIBCY3DrP4tod11qBt0y50feXCJkUsqB7S/99qfeP3R34ypJuqvOSzvPKH2Dis9eKxWZLg0ErZJw9PAuCsDH+t2Wi3o5TBQFTwSDQ70DSqNxXAg/2NwF7trGWp+mOvDSAizYjXYP2QYImAjiZbcnlusZ9WJsSSGD4AH32CRSmtDee67co1p9l9E3ZikWl5k/nzF5UQFhByk8OSn+MQAfaAyX9uXPz5V62tw0=
        file_glob: true
        file: images/*.tgz
        on:
          repo: lncm/docker-lnd
          tags: true

before_script: ./travis/before-script.sh
script: ./travis/script.sh

